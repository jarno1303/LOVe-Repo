{% extends "base.html" %}

{% block title %}Harjoittele - LOVe Enhanced{% endblock %}

{% block content %}
<div class="container">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="text-center py-5">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Ladataan...</span>
        </div>
        <p class="mt-3 text-muted">Ladataan kysymyksiä...</p>
    </div>

    <!-- Error Screen -->
    <div id="errorScreen" class="text-center py-5" style="display: none;">
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h4 class="alert-heading">Virhe kysymysten lataamisessa</h4>
            <p id="errorMessage">Tapahtui odottamaton virhe.</p>
            <hr>
            <button class="btn btn-primary" onclick="location.reload()">
                <i class="fas fa-redo me-2"></i>Yritä uudelleen
            </button>
            <a href="{{ url_for('dashboard_route') }}" class="btn btn-secondary">
                <i class="fas fa-home me-2"></i>Palaa dashboardiin
            </a>
        </div>
    </div>

    <!-- Question Screen -->
    <div id="questionScreen" style="display: none;">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2 class="mb-0">
                    <i class="fas fa-book-open text-primary me-2"></i>
                    Harjoittele
                </h2>
            </div>
            <div class="col-md-4 text-end">
                <div class="progress" style="height: 25px;">
                    <div id="progressBar" class="progress-bar bg-primary" role="progressbar" 
                         style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <span id="progressText">0/0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Question Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-body p-4">
                <h4 class="card-title mb-4" id="questionText">Kysymystä ladataan...</h4>
                <div id="optionsContainer"></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between">
            <button id="submitBtn" class="btn btn-primary btn-lg" onclick="submitAnswer()">
                <i class="fas fa-check me-2"></i>Vastaa
            </button>
            <button id="nextBtn" class="btn btn-success btn-lg" onclick="nextQuestion()" style="display: none;">
                <i class="fas fa-arrow-right me-2"></i>Seuraava
            </button>
            <a href="{{ url_for('dashboard_route') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-times me-2"></i>Lopeta
            </a>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="resultsScreen" style="display: none;">
        <div class="text-center py-5">
            <i id="resultsIcon" class="fas fa-trophy fa-5x text-warning mb-4"></i>
            <h2 id="resultsTitle" class="mb-3">Hienoa työtä!</h2>
            <div class="card shadow-sm d-inline-block">
                <div class="card-body p-4">
                    <h3 class="display-4 mb-2" id="scoreText">0/0</h3>
                    <p class="text-muted mb-0" id="percentageText">0%</p>
                </div>
            </div>
            <div class="mt-4">
                <button class="btn btn-primary btn-lg me-2" onclick="location.reload()">
                    <i class="fas fa-redo me-2"></i>Harjoittele uudelleen
                </button>
                <a href="{{ url_for('dashboard_route') }}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-home me-2"></i>Palaa dashboardiin
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Explanation Modal -->
<div class="modal fade" id="explanationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">
                <h5 class="modal-title" id="modalTitle">Selitys</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                Selitystä ladataan...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Jatka</button>
            </div>
        </div>
    </div>
</div>

<script>
    let questions = [];
    let currentQuestionIndex = 0;
    let correctAnswers = 0;
    let selectedOption = null;
    let startTime = null;
    let explanationModal = null;

    // Initialize Bootstrap modal
    document.addEventListener('DOMContentLoaded', function() {
        explanationModal = new bootstrap.Modal(document.getElementById('explanationModal'));
        fetchQuestions();
    });

    function showScreen(screenName, errorMsg = null) {
        // Hide all screens
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('errorScreen').style.display = 'none';
        document.getElementById('questionScreen').style.display = 'none';
        document.getElementById('resultsScreen').style.display = 'none';

        // Show requested screen
        if (screenName === 'loading') {
            document.getElementById('loadingScreen').style.display = 'block';
        } else if (screenName === 'error') {
            document.getElementById('errorScreen').style.display = 'block';
            if (errorMsg) {
                document.getElementById('errorMessage').textContent = errorMsg;
            }
        } else if (screenName === 'question') {
            document.getElementById('questionScreen').style.display = 'block';
        } else if (screenName === 'results') {
            document.getElementById('resultsScreen').style.display = 'block';
        }
    }

    async function fetchQuestions() {
        try {
            console.log('Haetaan kysymyksiä API:sta...');
            
            const urlParams = new URLSearchParams(window.location.search);

            // Käytetään getAll() kaikkien parametrien keräämiseksi taulukkoon
            // HUOM: getAll() palauttaa taulukon kaikista saman nimisistä parametreista
            // Esim. ?categories=a&categories=b => ['a', 'b']
            const categoriesArray = urlParams.getAll('categories');
            const difficultiesArray = urlParams.getAll('difficulties');
            
            // Yhdistetään taulukot pilkulla erotetuksi merkkijonoksi
            const categories = categoriesArray.join(',');
            const difficulties = difficultiesArray.join(',');
            const limit = urlParams.get('count') || '10';
            
            console.log('Parametrit:', { categories, difficulties, limit });
            
            // Tarkista että parametrit ovat järkevät
            const limitNum = parseInt(limit);
            if (isNaN(limitNum) || limitNum < 1 || limitNum > 100) {
                throw new Error('Kysymysten määrän tulee olla 1-100 välillä');
            }
            
            const response = await fetch(`/api/questions?limit=${limit}&category=${encodeURIComponent(categories)}&difficulties=${encodeURIComponent(difficulties)}`);
            
            console.log('API vastaus status:', response.status);
            
            // Tarkempi virheenkäsittely HTTP-statuksille
            if (!response.ok) {
                let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                
                try {
                    const errorData = await response.json();
                    if (errorData.error) {
                        errorMessage = errorData.error;
                    }
                } catch (e) {
                    // Jos JSON-parsinta epäonnistuu, käytä HTTP-virhettä
                }
                
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            console.log('Kysymysten haku onnistui. Kysymyksiä:', data.questions ? data.questions.length : 0);
            
            // Tarkista että saatiin kysymyksiä
            if (!data.questions || !Array.isArray(data.questions)) {
                throw new Error('Palvelin palautti virheellisen datan');
            }
            
            if (data.questions.length === 0) {
                throw new Error('Ei kysymyksiä saatavilla valituilla kriteereillä. Kokeile eri kategorioita tai vaikeustasoja.');
            }
            
            questions = data.questions;
            startTime = Date.now();
            
            console.log('Aloitetaan kysymysten näyttäminen');
            showScreen('question');
            displayCurrentQuestion();
            
        } catch (error) {
            console.error('Virhe kysymysten haussa:', error);
            
            // Näytä käyttäjäystävällinen virheilmoitus
            let userMessage = 'Kysymysten lataaminen epäonnistui.';
            
            if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                userMessage = 'Verkkovirhe. Tarkista internet-yhteytesi ja yritä uudelleen.';
            } else if (error.message) {
                userMessage = error.message;
            }
            
            showScreen('error', userMessage);
        }
    }

    function displayCurrentQuestion() {
        if (currentQuestionIndex >= questions.length) {
            showResults();
            return;
        }

        const question = questions[currentQuestionIndex];
        selectedOption = null;

        // Update progress
        const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = `${currentQuestionIndex + 1}/${questions.length}`;

        // Display question
        document.getElementById('questionText').textContent = question.question;

        // Display options
        const optionsContainer = document.getElementById('optionsContainer');
        optionsContainer.innerHTML = '';

        question.options.forEach((option, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'form-check p-3 mb-2 border rounded option-item';
            optionDiv.style.cursor = 'pointer';
            optionDiv.onclick = () => selectOption(index);
            
            optionDiv.innerHTML = `
                <input class="form-check-input" type="radio" name="answer" id="option${index}" value="${index}">
                <label class="form-check-label w-100" for="option${index}" style="cursor: pointer;">
                    ${String.fromCharCode(65 + index)}. ${option}
                </label>
            `;
            
            optionsContainer.appendChild(optionDiv);
        });

        // Reset buttons
        document.getElementById('submitBtn').style.display = 'inline-block';
        document.getElementById('nextBtn').style.display = 'none';
    }

    function selectOption(index) {
        selectedOption = index;
        
        // Update UI
        document.querySelectorAll('.option-item').forEach((item, i) => {
            if (i === index) {
                item.classList.add('border-primary', 'bg-light');
                item.querySelector('input').checked = true;
            } else {
                item.classList.remove('border-primary', 'bg-light');
                item.querySelector('input').checked = false;
            }
        });
    }

    async function submitAnswer() {
        if (selectedOption === null) {
            alert('Valitse vastaus ensin!');
            return;
        }

        const question = questions[currentQuestionIndex];
        const timeTaken = Math.floor((Date.now() - startTime) / 1000);

        try {
            const response = await fetch('/api/submit_answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question_id: question.id,
                    selected_option_text: question.options[selectedOption],
                    time_taken: timeTaken
                })
            });

            if (!response.ok) {
                throw new Error('Vastauksen lähetys epäonnistui');
            }

            const data = await response.json();

            // Update correct answers count
            if (data.correct) {
                correctAnswers++;
            }

            // Show visual feedback
            showAnswerFeedback(data.correct, data.correct_answer_index);

            // Show explanation in modal
            showExplanation(data.explanation, data.correct);

            // Show next button
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-block';

        } catch (error) {
            console.error('Virhe vastauksen lähetyksessä:', error);
            alert('Vastauksen lähetys epäonnistui. Yritä uudelleen.');
        }
    }

    function showAnswerFeedback(isCorrect, correctIndex) {
        document.querySelectorAll('.option-item').forEach((item, index) => {
            if (index === correctIndex) {
                item.classList.add('border-success', 'bg-success', 'bg-opacity-10');
                item.classList.remove('border-primary');
            } else if (index === selectedOption && !isCorrect) {
                item.classList.add('border-danger', 'bg-danger', 'bg-opacity-10');
                item.classList.remove('border-primary');
            }
        });
    }

    function showExplanation(explanation, isCorrect) {
        const modalHeader = document.getElementById('modalHeader');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        if (isCorrect) {
            modalHeader.className = 'modal-header bg-success text-white';
            modalTitle.innerHTML = '<i class="fas fa-check-circle me-2"></i>Oikein!';
        } else {
            modalHeader.className = 'modal-header bg-danger text-white';
            modalTitle.innerHTML = '<i class="fas fa-times-circle me-2"></i>Väärin';
        }

        modalBody.textContent = explanation;
        explanationModal.show();
    }

    function nextQuestion() {
        currentQuestionIndex++;
        startTime = Date.now();
        displayCurrentQuestion();
    }

    function showResults() {
        const percentage = Math.round((correctAnswers / questions.length) * 100);
        
        document.getElementById('scoreText').textContent = `${correctAnswers}/${questions.length}`;
        document.getElementById('percentageText').textContent = `${percentage}%`;

        // Update icon and title based on performance
        const icon = document.getElementById('resultsIcon');
        const title = document.getElementById('resultsTitle');

        if (percentage >= 90) {
            icon.className = 'fas fa-trophy fa-5x text-warning mb-4';
            title.textContent = 'Erinomaista! 🎉';
        } else if (percentage >= 70) {
            icon.className = 'fas fa-star fa-5x text-primary mb-4';
            title.textContent = 'Hyvä työ! 👏';
        } else if (percentage >= 50) {
            icon.className = 'fas fa-check-circle fa-5x text-success mb-4';
            title.textContent = 'Kohtuullista! 👍';
        } else {
            icon.className = 'fas fa-book fa-5x text-info mb-4';
            title.textContent = 'Harjoittelua lisää! 📚';
        }

        showScreen('results');
    }
</script>

<style>
    .option-item {
        transition: all 0.3s ease;
    }

    .option-item:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }

    .progress {
        border-radius: 10px;
    }

    .progress-bar {
        transition: width 0.5s ease;
    }
</style>
{% endblock %}