{% extends "base.html" %}

{% block title %}Harjoittele - LOVe Enhanced{% endblock %}

{% block content %}
<div class="container">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="text-center py-5">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Ladataan...</span>
        </div>
        <p class="mt-3 text-muted">Ladataan kysymyksiä...</p>
    </div>

    <!-- Error Screen -->
    <div id="errorScreen" class="text-center py-5" style="display: none;">
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h4 class="alert-heading">Virhe kysymysten lataamisessa</h4>
            <p id="errorMessage">Tapahtui odottamaton virhe.</p>
            <hr>
            <button class="btn btn-primary" onclick="location.reload()">
                <i class="fas fa-redo me-2"></i>Yritä uudelleen
            </button>
            <a href="{{ url_for('dashboard_route') }}" class="btn btn-secondary">
                <i class="fas fa-home me-2"></i>Palaa dashboardiin
            </a>
        </div>
    </div>

    <!-- Question Screen -->
    <div id="questionScreen" style="display: none;">
         <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
            
            <div class="mb-2 mb-md-0">
                <h2 class="mb-0">
                    <i class="fas fa-book-open text-primary me-2"></i>
                    Harjoittele
                </h2>
            </div>
            
            <div class="flex-grow-1 ms-md-4">
                <div class="d-flex justify-content-end mb-1">
                    <span id="progressText" class="fw-bold text-muted">Kysymys 0 / 0</span>
                </div>
                <div class="progress" style="height: 12px;">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>

        </div>

        <!-- Question Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-body p-4">
                <!-- Edistymisinfo -->
                <div id="question-progress-info" class="alert alert-info mb-3" style="display: none;">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <small class="text-muted">Edistymisesi tässä kysymyksessä:</small>
                            <div class="d-flex gap-3 mt-1">
                                <span><i class="fas fa-eye"></i> Nähty: <strong id="prog-times-shown">0</strong> kertaa</span>
                                <span><i class="fas fa-check-circle text-success"></i> Oikein: <strong id="prog-times-correct">0</strong></span>
                                <span><i class="fas fa-chart-line"></i> Onnistuminen: <strong id="prog-success-rate">0%</strong></span>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">Viimeksi: <span id="prog-last-shown">-</span></small>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h4 class="card-title mb-0 flex-grow-1" id="questionText">Kysymystä ladataan...</h4>
                    <button class="btn btn-outline-info btn-sm ms-3" onclick="openHelper()" title="Avaa avustaja">
                        <i class="fas fa-lightbulb me-1"></i>Avustaja
                    </button>
                </div>
                <div id="optionsContainer"></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between">
            <button id="submitBtn" class="btn btn-primary btn-lg" onclick="submitAnswer()">
                <i class="fas fa-check me-2"></i>Vastaa
            </button>
            <button id="nextBtn" class="btn btn-success btn-lg" onclick="nextQuestion()" style="display: none;">
                <i class="fas fa-arrow-right me-2"></i>Seuraava
            </button>
            <a href="{{ url_for('dashboard_route') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-times me-2"></i>Lopeta
            </a>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="resultsScreen" style="display: none;">
        <div class="text-center py-5">
            <i id="resultsIcon" class="fas fa-trophy fa-5x text-warning mb-4"></i>
            <h2 id="resultsTitle" class="mb-3">Hienoa työtä!</h2>
            <div class="card shadow-sm d-inline-block">
                <div class="card-body p-4">
                    <h3 class="display-4 mb-2" id="scoreText">0/0</h3>
                    <p class="text-muted mb-0" id="percentageText">0%</p>
                </div>
            </div>
            <div class="mt-4">
                <button class="btn btn-primary btn-lg me-2" onclick="location.reload()">
                    <i class="fas fa-redo me-2"></i>Harjoittele uudelleen
                </button>
                <a href="{{ url_for('dashboard_route') }}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-home me-2"></i>Palaa dashboardiin
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Kelluva laskin -->
<button id="floating-calculator-btn" class="btn btn-primary rounded-circle shadow-lg" 
        onclick="toggleCalculator()" 
        title="Avaa laskin"
        style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 1000;">
    <i class="fas fa-calculator fa-lg"></i>
</button>

<!-- Laskin Modal - TÄMÄ PUUTTUI! -->
<div id="calculator-modal" style="display: none; position: fixed; bottom: 90px; right: 20px; z-index: 1001; width: 300px;">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" 
             id="calc-header" 
             style="cursor: move;">
            <span><i class="fas fa-calculator me-2"></i>Laskin <small class="text-white-50">(vedä siirtääksesi)</small></span>
            <button class="btn btn-sm btn-outline-light" onclick="toggleCalculator()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="card-body p-3">
            <input type="text" id="calc-display" class="form-control form-control-lg text-end mb-3" readonly value="0">
            <div class="d-grid gap-2" style="grid-template-columns: repeat(4, 1fr);">
                <button class="btn btn-outline-secondary" onclick="calcInput('7')">7</button>
                <button class="btn btn-outline-secondary" onclick="calcInput('8')">8</button>
                <button class="btn btn-outline-secondary" onclick="calcInput('9')">9</button>
                <button class="btn btn-warning" onclick="calcInput('/')">/</button>
                
                <button class="btn btn-outline-secondary" onclick="calcInput('4')">4</button>
                <button class="btn btn-outline-secondary" onclick="calcInput('5')">5</button>
                <button class="btn btn-outline-secondary" onclick="calcInput('6')">6</button>
                <button class="btn btn-warning" onclick="calcInput('*')">×</button>
                
                <button class="btn btn-outline-secondary" onclick="calcInput('1')">1</button>
                <button class="btn btn-outline-secondary" onclick="calcInput('2')">2</button>
                <button class="btn btn-outline-secondary" onclick="calcInput('3')">3</button>
                <button class="btn btn-warning" onclick="calcInput('-')">−</button>
                
                <button class="btn btn-outline-secondary" onclick="calcInput('0')">0</button>
                <button class="btn btn-outline-secondary" onclick="calcInput('.')">.</button>
                <button class="btn btn-success" onclick="calcEqual()">=</button>
                <button class="btn btn-warning" onclick="calcInput('+')">+</button>
                
                <button class="btn btn-danger" onclick="calcClear()" style="grid-column: span 4;">C</button>
            </div>
        </div>
    </div>
</div>

<!-- Explanation Modal -->
<div class="modal fade" id="explanationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">
                <h5 class="modal-title" id="modalTitle">Selitys</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                Selitystä ladataan...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Jatka</button>
            </div>
        </div>
    </div>
</div>

<!-- Helper/Avustaja Modal -->
<div class="modal fade" id="helperModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-lightbulb me-2"></i>Avustaja - Askel askeleelta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="helperBody">
                <!-- Dynaaminen sisältö -->
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('calculator_route') }}" class="btn btn-outline-primary" target="_blank">
                    <i class="fas fa-calculator me-2"></i>Avaa laskuri
                </a>
                <button type="button" class="btn btn-info" data-bs-dismiss="modal">Sulje</button>
            </div>
        </div>
    </div>
</div>

<script>
    let questions = [];
    let currentQuestionIndex = 0;
    let correctAnswers = 0;
    let selectedOption = null;
    let startTime = null;
    let explanationModal = null;
    let helperModal = null;

    // Laskin muuttujat
    let calcCurrentValue = '0';
    let calcOperator = '';
    let calcPreviousValue = '';

    // Drag muuttujat - NÄMÄ PUUTTUIVAT!
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;

    document.addEventListener('DOMContentLoaded', function() {
        explanationModal = new bootstrap.Modal(document.getElementById('explanationModal'));
        helperModal = new bootstrap.Modal(document.getElementById('helperModal'));
        initCalculatorDrag(); // TÄMÄ PUUTTUI!
        fetchQuestions();
    });

    function showScreen(screenName, errorMsg = null) {
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('errorScreen').style.display = 'none';
        document.getElementById('questionScreen').style.display = 'none';
        document.getElementById('resultsScreen').style.display = 'none';

        if (screenName === 'loading') {
            document.getElementById('loadingScreen').style.display = 'block';
        } else if (screenName === 'error') {
            document.getElementById('errorScreen').style.display = 'block';
            if (errorMsg) {
                document.getElementById('errorMessage').textContent = errorMsg;
            }
        } else if (screenName === 'question') {
            document.getElementById('questionScreen').style.display = 'block';
        } else if (screenName === 'results') {
            document.getElementById('resultsScreen').style.display = 'block';
        }
    }

    async function fetchQuestions() {
        try {
            console.log('Haetaan kysymyksiä API:sta...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const categoriesArray = urlParams.getAll('categories');
            const difficultiesArray = urlParams.getAll('difficulties');
            const categories = categoriesArray.join(',');
            const difficulties = difficultiesArray.join(',');
            const limit = urlParams.get('count') || '10';
            
            console.log('Parametrit:', { categories, difficulties, limit });
            
            const limitNum = parseInt(limit);
            if (isNaN(limitNum) || limitNum < 1 || limitNum > 100) {
                throw new Error('Kysymysten määrän tulee olla 1-100 välillä');
            }
            
            const response = await fetch(`/api/questions?limit=${limit}&category=${encodeURIComponent(categories)}&difficulties=${encodeURIComponent(difficulties)}`);
            
            console.log('API vastaus status:', response.status);
            
            if (!response.ok) {
                let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    if (errorData.error) {
                        errorMessage = errorData.error;
                    }
                } catch (e) {}
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            console.log('Kysymysten haku onnistui. Kysymyksiä:', data.questions ? data.questions.length : 0);
            
            if (!data.questions || !Array.isArray(data.questions)) {
                throw new Error('Palvelin palautti virheellisen datan');
            }
            
            if (data.questions.length === 0) {
                throw new Error('Ei kysymyksiä saatavilla valituilla kriteereillä.');
            }
            
            questions = data.questions;
            startTime = Date.now();
            
            console.log('Aloitetaan kysymysten näyttäminen');
            showScreen('question');
            displayCurrentQuestion();
            
        } catch (error) {
            console.error('Virhe kysymysten haussa:', error);
            
            let userMessage = 'Kysymysten lataaminen epäonnistui.';
            
            if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                userMessage = 'Verkkovirhe. Tarkista internet-yhteytesi ja yritä uudelleen.';
            } else if (error.message) {
                userMessage = error.message;
            }
            
            showScreen('error', userMessage);
        }
    }

    async function displayCurrentQuestion() {
        if (currentQuestionIndex >= questions.length) {
            showResults();
            return;
        }

        const question = questions[currentQuestionIndex];
        selectedOption = null;

        const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = `${currentQuestionIndex + 1}/${questions.length}`;

        await loadQuestionProgress(question.id);

        document.getElementById('questionText').textContent = question.question;

        const optionsContainer = document.getElementById('optionsContainer');
        optionsContainer.innerHTML = '';

        question.options.forEach((option, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'form-check p-3 mb-2 border rounded option-item';
            optionDiv.style.cursor = 'pointer';
            optionDiv.onclick = () => selectOption(index);
            
            optionDiv.innerHTML = `
                <input class="form-check-input" type="radio" name="answer" id="option${index}" value="${index}">
                <label class="form-check-label w-100" for="option${index}" style="cursor: pointer;">
                    ${String.fromCharCode(65 + index)}. ${option}
                </label>
            `;
            
            optionsContainer.appendChild(optionDiv);
        });

        document.getElementById('submitBtn').style.display = 'inline-block';
        document.getElementById('nextBtn').style.display = 'none';
    }

    async function loadQuestionProgress(questionId) {
        try {
            const response = await fetch(`/api/question_progress/${questionId}`);
            const data = await response.json();
            
            const progressInfo = document.getElementById('question-progress-info');
            
            if (data.times_shown > 0) {
                document.getElementById('prog-times-shown').textContent = data.times_shown;
                document.getElementById('prog-times-correct').textContent = data.times_correct;
                document.getElementById('prog-success-rate').textContent = data.success_rate + '%';
                
                if (data.last_shown) {
                    const lastDate = new Date(data.last_shown);
                    const now = new Date();
                    const diffDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));
                    
                    let lastShownText;
                    if (diffDays === 0) {
                        lastShownText = 'Tänään';
                    } else if (diffDays === 1) {
                        lastShownText = 'Eilen';
                    } else if (diffDays < 7) {
                        lastShownText = diffDays + ' päivää sitten';
                    } else {
                        lastShownText = Math.floor(diffDays / 7) + ' viikkoa sitten';
                    }
                    document.getElementById('prog-last-shown').textContent = lastShownText;
                }
                
                const successRate = data.success_rate;
                const progressCard = document.getElementById('question-progress-info');
                
                if (successRate >= 80) {
                    progressCard.className = 'alert alert-success mb-3';
                } else if (successRate >= 50) {
                    progressCard.className = 'alert alert-warning mb-3';
                } else {
                    progressCard.className = 'alert alert-danger mb-3';
                }
                
                progressInfo.style.display = 'block';
            } else {
                progressInfo.style.display = 'none';
            }
            
        } catch (error) {
            console.error('Virhe edistymisen lataamisessa:', error);
            document.getElementById('question-progress-info').style.display = 'none';
        }
    }

    function selectOption(index) {
        selectedOption = index;
        
        document.querySelectorAll('.option-item').forEach((item, i) => {
            if (i === index) {
                item.classList.add('border-primary', 'bg-light');
                item.querySelector('input').checked = true;
            } else {
                item.classList.remove('border-primary', 'bg-light');
                item.querySelector('input').checked = false;
            }
        });
    }

    async function submitAnswer() {
        if (selectedOption === null) {
            alert('Valitse vastaus ensin!');
            return;
        }

        const question = questions[currentQuestionIndex];
        const timeTaken = Math.floor((Date.now() - startTime) / 1000);

        try {
            const response = await fetch('/api/submit_answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question_id: question.id,
                    selected_option_text: question.options[selectedOption],
                    time_taken: timeTaken
                })
            });

            if (!response.ok) {
                throw new Error('Vastauksen lähetys epäonnistui');
            }

            const data = await response.json();

            if (data.correct) {
                correctAnswers++;
            }

            showAnswerFeedback(data.correct, data.correct_answer_index);
            showExplanation(data.explanation, data.correct);

            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-block';

        } catch (error) {
            console.error('Virhe vastauksen lähetyksessä:', error);
            alert('Vastauksen lähetys epäonnistui. Yritä uudelleen.');
        }
    }

    function showAnswerFeedback(isCorrect, correctIndex) {
        document.querySelectorAll('.option-item').forEach((item, index) => {
            if (index === correctIndex) {
                item.classList.add('border-success', 'bg-success', 'bg-opacity-10');
                item.classList.remove('border-primary');
            } else if (index === selectedOption && !isCorrect) {
                item.classList.add('border-danger', 'bg-danger', 'bg-opacity-10');
                item.classList.remove('border-primary');
            }
        });
    }

    function showExplanation(explanation, isCorrect) {
        const modalHeader = document.getElementById('modalHeader');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        if (isCorrect) {
            modalHeader.className = 'modal-header bg-success text-white';
            modalTitle.innerHTML = '<i class="fas fa-check-circle me-2"></i>Oikein!';
        } else {
            modalHeader.className = 'modal-header bg-danger text-white';
            modalTitle.innerHTML = '<i class="fas fa-times-circle me-2"></i>Väärin';
        }

        modalBody.textContent = explanation;
        explanationModal.show();
    }

    function nextQuestion() {
        currentQuestionIndex++;
        startTime = Date.now();
        displayCurrentQuestion();
    }

    function showResults() {
        const percentage = Math.round((correctAnswers / questions.length) * 100);
        
        document.getElementById('scoreText').textContent = `${correctAnswers}/${questions.length}`;
        document.getElementById('percentageText').textContent = `${percentage}%`;

        const icon = document.getElementById('resultsIcon');
        const title = document.getElementById('resultsTitle');

        if (percentage >= 90) {
            icon.className = 'fas fa-trophy fa-5x text-warning mb-4';
            title.textContent = 'Erinomaista!';
        } else if (percentage >= 70) {
            icon.className = 'fas fa-star fa-5x text-primary mb-4';
            title.textContent = 'Hyvä työ!';
        } else if (percentage >= 50) {
            icon.className = 'fas fa-check-circle fa-5x text-success mb-4';
            title.textContent = 'Kohtuullista!';
        } else {
            icon.className = 'fas fa-book fa-5x text-info mb-4';
            title.textContent = 'Harjoittelua lisää!';
        }

        showScreen('results');
    }

    // Laskin funktiot
    function toggleCalculator() {
        const modal = document.getElementById('calculator-modal');
        if (modal.style.display === 'none') {
            modal.style.display = 'block';
        } else {
            modal.style.display = 'none';
        }
    }

    function calcInput(value) {
        const display = document.getElementById('calc-display');
        
        if (['+', '-', '*', '/'].includes(value)) {
            calcOperator = value;
            calcPreviousValue = calcCurrentValue;
            calcCurrentValue = '0';
        } else if (value === '.') {
            if (!calcCurrentValue.includes('.')) {
                calcCurrentValue += '.';
            }
        } else {
            if (calcCurrentValue === '0') {
                calcCurrentValue = value;
            } else {
                calcCurrentValue += value;
            }
        }
        
        display.value = calcCurrentValue;
    }

    function calcEqual() {
        const display = document.getElementById('calc-display');
        let result = 0;
        const prev = parseFloat(calcPreviousValue);
        const curr = parseFloat(calcCurrentValue);
        
        switch(calcOperator) {
            case '+':
                result = prev + curr;
                break;
            case '-':
                result = prev - curr;
                break;
            case '*':
                result = prev * curr;
                break;
            case '/':
                result = prev / curr;
                break;
            default:
                return;
        }
        
        calcCurrentValue = result.toString();
        calcOperator = '';
        calcPreviousValue = '';
        display.value = calcCurrentValue;
    }

    function calcClear() {
        calcCurrentValue = '0';
        calcOperator = '';
        calcPreviousValue = '';
        document.getElementById('calc-display').value = '0';
    }

    // Drag-toiminnallisuus - NÄMÄ FUNKTIOT PUUTTUIVAT!
    function initCalculatorDrag() {
        const calcHeader = document.getElementById('calc-header');
        
        calcHeader.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
        
        calcHeader.addEventListener('touchstart', dragStart);
        document.addEventListener('touchmove', drag);
        document.addEventListener('touchend', dragEnd);
    }

    function dragStart(e) {
        if (e.type === "touchstart") {
            initialX = e.touches[0].clientX - xOffset;
            initialY = e.touches[0].clientY - yOffset;
        } else {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
        }
        
        if (e.target === document.getElementById('calc-header') || 
            e.target.closest('#calc-header')) {
            isDragging = true;
        }
    }

    function drag(e) {
        if (isDragging) {
            e.preventDefault();
            
            const calcModal = document.getElementById('calculator-modal');
            
            if (e.type === "touchmove") {
                currentX = e.touches[0].clientX - initialX;
                currentY = e.touches[0].clientY - initialY;
            } else {
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
            }
            
            xOffset = currentX;
            yOffset = currentY;
            
            const rect = calcModal.getBoundingClientRect();
            
            calcModal.style.right = 'auto';
            calcModal.style.bottom = 'auto';
            calcModal.style.left = (rect.left + currentX) + 'px';
            calcModal.style.top = (rect.top + currentY) + 'px';
        }
    }

    function dragEnd(e) {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
    }

    // Avustaja-toiminnot
    function openHelper() {
        const question = questions[currentQuestionIndex];
        const helperBody = document.getElementById('helperBody');
        
        const questionType = identifyQuestionType(question);
        
        let helperContent = '';
        
        switch(questionType) {
            case 'dose':
                helperContent = generateDoseHelper(question);
                break;
            case 'infusion':
                helperContent = generateInfusionHelper(question);
                break;
            case 'weight':
                helperContent = generateWeightHelper(question);
                break;
            case 'percent':
                helperContent = generatePercentHelper(question);
                break;
            default:
                helperContent = generateGenericHelper(question, questionType === 'calculation');
                break;
        }
        
        helperBody.innerHTML = helperContent;
        helperModal.show();
    }

    function identifyQuestionType(question) {
        const text = question.question.toLowerCase();
        const category = question.category ? question.category.toLowerCase() : '';
        const options = question.options ? question.options.join(' ').toLowerCase() : '';
        const allText = (text + ' ' + category + ' ' + options).toLowerCase();
        
        const hasNumbers = /\d/.test(text);
        
        if (allText.match(/annos|tabletti|kapseli|mg\/|liuos.*mg|vahvuus|dog|määrätty.*saatavilla/i)) {
            if (hasNumbers || allText.includes('laske') || allText.includes('tarvitaan')) {
                return 'dose';
            }
        }
        
        if (allText.match(/infuusio|tippa|gtt|ml\/h|ml\/min|tiputus|infuusionopeus/i)) {
            if (hasNumbers || allText.includes('laske') || allText.includes('nopeus')) {
                return 'infusion';
            }
        }
        
        if (allText.match(/paino.*kg|kg.*annos|mg\/kg|painoperusteinen|potilaan paino/i)) {
            if (hasNumbers || allText.includes('laske')) {
                return 'weight';
            }
        }
        
        if (allText.match(/%|prosentti|liuos.*g\/|konsentraatio/i)) {
            if (hasNumbers || allText.includes('laske')) {
                return 'percent';
            }
        }
        
        if (hasNumbers && (allText.includes('laske') || allText.includes('montako') || allText.includes('kuinka'))) {
            return 'calculation';
        }
        
        return 'theory';
    }

    function generateDoseHelper(question) {
        return `
            <div class="alert alert-info">
                <h5><i class="fas fa-pills me-2"></i>Annoslaskenta</h5>
                <p class="mb-0">Tämä on annoslaskentakysymys. Käytä DOG-muistisääntöä!</p>
            </div>
            
            <h6 class="mt-3">Vaihe 1: Tunnista arvot</h6>
            <p>Etsi kysymyksestä:</p>
            <ul>
                <li><strong>Määrätty annos</strong> (mitä pitää antaa)</li>
                <li><strong>Saatavilla oleva vahvuus</strong> (lääkkeen vahvuus)</li>
                <li><strong>Lääkkeen määrä</strong> (esim. ml tai kpl per yksikkö)</li>
            </ul>

            <h6 class="mt-3">Vaihe 2: Käytä kaavaa</h6>
            <div class="alert alert-light border">
                <strong>DOG - Dose Over Got</strong><br>
                Tarvittava = (Määrätty ÷ Saatavilla) × Määrä
            </div>

            <h6 class="mt-3">Vaihe 3: Laske ja tarkista</h6>
            <p>Onko tulos järkevä? Jos saat esim. 10 tablettia, tarkista laskusi!</p>

            <div class="card bg-light mt-3">
                <div class="card-body">
                    <h6>Muistisääntö:</h6>
                    <p class="mb-0"><strong>D</strong>ose (Määrätty) <strong>O</strong>ver (jaettuna) <strong>G</strong>ot (Saatavilla)</p>
                </div>
            </div>
        `;
    }

    function generateInfusionHelper(question) {
        return `
            <div class="alert alert-info">
                <h5><i class="fas fa-tint me-2"></i>Infuusiolaskenta</h5>
                <p class="mb-0">Tämä on infuusionopeuskysymys.</p>
            </div>
            
            <h6 class="mt-3">Vaihe 1: Tunnista arvot</h6>
            <ul>
                <li><strong>Tilavuus</strong> (ml)</li>
                <li><strong>Aika</strong> (tunnit tai minuutit)</li>
                <li><strong>Tippakerroin</strong> (yleensä 20 gtt/ml)</li>
            </ul>

            <h6 class="mt-3">Vaihe 2: Valitse oikea kaava</h6>
            <div class="alert alert-light border">
                <p><strong>ml/h:</strong> Tilavuus ÷ Aika (tunneissa)</p>
                <p class="mb-0"><strong>gtt/min:</strong> (Tilavuus × Tippakerroin) ÷ Aika (minuutteina)</p>
            </div>

            <h6 class="mt-3">Vaihe 3: Muista muunnokset</h6>
            <ul>
                <li>1 tunti = 60 minuuttia</li>
                <li>1 ml = 20 tippaa (standardi)</li>
            </ul>

            <div class="card bg-light mt-3">
                <div class="card-body">
                    <h6>Muistisääntö:</h6>
                    <p class="mb-0">"20 tippaa tekee millin" - 1 ml = 20 gtt</p>
                </div>
            </div>
        `;
    }

    function generateWeightHelper(question) {
        return `
            <div class="alert alert-info">
                <h5><i class="fas fa-weight me-2"></i>Painoperusteinen annos</h5>
                <p class="mb-0">Tämä on painoperusteinen laskukysymys.</p>
            </div>
            
            <h6 class="mt-3">Vaihe 1: Tunnista arvot</h6>
            <ul>
                <li><strong>Potilaan paino</strong> (kg)</li>
                <li><strong>Annos per kilogramma</strong> (mg/kg, μg/kg, jne.)</li>
            </ul>

            <h6 class="mt-3">Vaihe 2: Käytä kaavaa</h6>
            <div class="alert alert-light border">
                <strong>Kokonaisannos = Paino × Annos per kg</strong>
            </div>

            <h6 class="mt-3">Vaihe 3: Tarkista</h6>
            <p>Muista tarkistaa että tulos on yksikkörajojen sisällä!</p>

            <div class="card bg-warning bg-opacity-10 mt-3">
                <div class="card-body">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Huom!</h6>
                    <p class="mb-0">Tarkista aina maksimiannosrajoitukset ennen antamista!</p>
                </div>
            </div>
        `;
    }

    function generatePercentHelper(question) {
        return `
            <div class="alert alert-info">
                <h5><i class="fas fa-percent me-2"></i>Prosenttilaskenta</h5>
                <p class="mb-0">Tämä on prosenttilaskukysymys.</p>
            </div>
            
            <h6 class="mt-3">Muista perussääntö</h6>
            <div class="alert alert-light border">
                <strong>% = grammaa per 100 ml</strong>
            </div>

            <h6 class="mt-3">Esimerkkejä:</h6>
            <ul>
                <li>5% = 5 g / 100 ml = 50 mg/ml</li>
                <li>0,9% = 0,9 g / 100 ml = 9 mg/ml</li>
                <li>10% = 10 g / 100 ml = 100 mg/ml</li>
            </ul>

            <h6 class="mt-3">Pikanäppäin</h6>
            <div class="alert alert-success">
                <p class="mb-0"><strong>Kerro % luku 10:llä → saat mg/ml</strong></p>
            </div>

            <div class="card bg-light mt-3">
                <div class="card-body">
                    <h6>Muistisääntö:</h6>
                    <p class="mb-0">"Prosentti on sata" - % tarkoittaa per 100 ml</p>
                </div>
            </div>
        `;
    }

    function generateGenericHelper(question, isCalculation = false) {
        const text = question.question.toLowerCase();
        const hasNumbers = /\d/.test(text);
        
        if (isCalculation || hasNumbers) {
            return `
                <div class="alert alert-warning">
                    <h5><i class="fas fa-calculator me-2"></i>Laskukysymys</h5>
                    <p class="mb-0">Tämä vaikuttaa laskukysymykseltä, mutta en tunnistanut tarkkaa tyyppiä.</p>
                </div>
                
                <h6 class="mt-3">Yleinen laskuohje:</h6>
                
                <p><strong>Vaihe 1:</strong> Etsi kysymyksestä</p>
                <ul>
                    <li>Kaikki numerot ja niiden yksiköt (mg, ml, kg, %, h, min...)</li>
                    <li>Mitä kysytään? (montako, kuinka paljon, mikä nopeus...)</li>
                </ul>

                <p><strong>Vaihe 2:</strong> Tunnista laskutyyppi ja valitse kaava</p>
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <strong>Annoslaskenta?</strong><br>
                        <small>Kaava: (Määrätty ÷ Saatavilla) × Määrä</small><br>
                        <small class="text-muted">Muistisääntö: DOG - Dose Over Got</small>
                    </div>
                </div>
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <strong>Infuusionopeus?</strong><br>
                        <small>ml/h = Tilavuus ÷ Aika (h)</small><br>
                        <small>gtt/min = (Tilavuus × 20) ÷ Aika (min)</small>
                    </div>
                </div>
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <strong>Painoperusteinen?</strong><br>
                        <small>Annos = Paino × Annos/kg</small>
                    </div>
                </div>
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <strong>Prosenttilaskenta?</strong><br>
                        <small>% = g/100ml, sitten × 10 = mg/ml</small>
                    </div>
                </div>

                <p class="mt-3"><strong>Vaihe 3:</strong> Laske ja tarkista tulos</p>
                <p class="small">Onko vastaus järkevä? 10 tablettia tai 0,001 ml kuulostavat epäilyttäviltä!</p>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-calculator me-2"></i>
                    <strong>Käytä kelluvaa laskinta</strong> oikeassa alakulmassa laskujen tekemiseen!
                </div>
            `;
        } else {
            return `
                <div class="alert alert-info">
                    <h5><i class="fas fa-book me-2"></i>Teoriakysymys</h5>
                    <p class="mb-0">Tämä kysymys koskee lääkehoidon teoriaa ja käytäntöjä.</p>
                </div>
                
                <h6 class="mt-3">Strategia teoriakysymyksiin:</h6>
                
                <div class="card mb-2">
                    <div class="card-body">
                        <p class="mb-2"><strong>1. Lue kysymys kahdesti</strong></p>
                        <p class="small text-muted mb-0">Varmista että ymmärrät mitä kysytään. Huomaa avainsanat.</p>
                    </div>
                </div>

                <div class="card mb-2">
                    <div class="card-body">
                        <p class="mb-2"><strong>2. Analysoi jokainen vaihtoehto</strong></p>
                        <p class="small text-muted mb-0">Mikä kuulostaa loogiselta? Mikä on käytännössä järkevää?</p>
                    </div>
                </div>

                <div class="card mb-2">
                    <div class="card-body">
                        <p class="mb-2"><strong>3. Poissulje mahdottomat</strong></p>
                        <p class="small text-muted mb-0">Mitkä vaihtoehdot ovat selvästi väärin? Jää 2-3 vaihtoehtoa.</p>
                    </div>
                </div>

                <div class="card mb-2">
                    <div class="card-body">
                        <p class="mb-2"><strong>4. Mieti käytännön tilannetta</strong></p>
                        <p class="small text-muted mb-0">Miten toimitaan oikeassa työtilanteessa? Mikä on turvallista?</p>
                    </div>
                </div>

                <div class="card mb-2">
                    <div class="card-body">
                        <p class="mb-2"><strong>5. Valitse paras vastaus</strong></p>
                        <p class="small text-muted mb-0">Kaikki vaihtoehdot voivat kuulostaa oikeilta, mutta mikä on PARAS vastaus?</p>
                    </div>
                </div>

                <h6 class="mt-4">Tämän kysymyksen aihe:</h6>
                <div class="card bg-light">
                    <div class="card-body">
                        <p class="mb-0">"${question.question}"</p>
                    </div>
                </div>

                <div class="alert alert-secondary mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Jos et ole varma vastauksesta, valitse vaihtoehto joka on <strong>turvallisin potilaalle</strong>.
                </div>
            `;
        }
    }
</script>

<style>
    .option-item {
        transition: all 0.3s ease;
    }

    .option-item:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }

    .progress {
        border-radius: 10px;
    }

    .progress-bar {
        transition: width 0.5s ease;
    }

    #question-progress-info {
        border-left: 4px solid;
        transition: all 0.3s ease;
    }

    #question-progress-info.alert-success {
        border-left-color: #28a745;
    }

    #question-progress-info.alert-warning {
        border-left-color: #ffc107;
    }

    #question-progress-info.alert-danger {
        border-left-color: #dc3545;
    }

    #question-progress-info small {
        display: block;
        margin-bottom: 0.25rem;
    }

    #question-progress-info .d-flex {
        font-size: 0.95rem;
    }

    #floating-calculator-btn {
        transition: all 0.3s ease;
    }

    #floating-calculator-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    }

    #calculator-modal .btn {
        padding: 12px;
        font-size: 1.1rem;
        font-weight: bold;
    }

    #calc-header {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    #calc-header:active {
        cursor: grabbing !important;
    }
</style>
{% endblock %}