{% extends "base.html" %}

{% block title %}Tilastot - LOVe Enhanced{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-chart-line me-2"></i>Tilastot</h1>
        <a href="/dashboard" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Takaisin
        </a>
    </div>

    <!-- Latausspinneri -->
    <div id="loading-spinner" class="text-center my-5">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Ladataan...</span>
        </div>
        <p class="mt-3 text-muted">Ladataan tilastoja...</p>
    </div>

    <!-- Tyhjä tila -->
    <div id="empty-state" style="display: none;">
        <div class="card shadow-lg border-0 text-center p-5">
            <div class="card-body">
                <i class="fas fa-chart-line fa-5x text-muted mb-4"></i>
                <h2 class="mb-3">Ei vielä tilastoja</h2>
                <p class="lead text-muted mb-4">
                    Aloita harjoittelu nähdäksesi tilastosi ja edistymisesi!
                </p>
                <div class="d-flex gap-3 justify-content-center">
                    <a href="/practice" class="btn btn-primary btn-lg">
                        <i class="fas fa-play-circle me-2"></i>Aloita harjoittelu
                    </a>
                    <a href="/simulation" class="btn btn-outline-primary btn-lg">
                        <i class="fas fa-clipboard-check me-2"></i>Kokeile simulaatiota
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Tilastojen sisältö -->
    <div id="stats-content" style="display: none;">
        <!-- Yleiset tilastot -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-question-circle fa-2x text-primary mb-2"></i>
                        <h3 id="total-questions" class="mb-1">0</h3>
                        <p class="text-muted mb-0 small">Vastattuja kysymyksiä</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h3 id="success-rate" class="mb-1">0%</h3>
                        <p class="text-muted mb-0 small">Onnistumisprosentti</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                        <h3 id="avg-time" class="mb-1">0s</h3>
                        <p class="text-muted mb-0 small">Keskimääräinen aika</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-fire fa-2x text-danger mb-2"></i>
                        <h3 id="current-streak" class="mb-1">0</h3>
                        <p class="text-muted mb-0 small">Päivän putki</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kategoriakohtaiset tilastot -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Kategoriat</h5>
            </div>
            <div class="card-body">
                <div id="category-stats-container">
                    <p class="text-muted text-center">Ladataan kategoriatilastroja...</p>
                </div>
            </div>
        </div>

        <!-- Vaikeustasokohtaiset tilastot -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Vaikeustasot</h5>
            </div>
            <div class="card-body">
                <div id="difficulty-stats-container">
                    <p class="text-muted text-center">Ladataan vaikeustasostatistoja...</p>
                </div>
            </div>
        </div>

        <!-- Viikottainen edistyminen -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-calendar-week me-2"></i>Viimeisen 30 päivän aktiivisuus</h5>
            </div>
            <div class="card-body">
                <canvas id="weekly-progress-chart" height="80"></canvas>
            </div>
        </div>

        <!-- Viimeisimmät sessiot -->
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Viimeisimmät harjoitussessiot</h5>
            </div>
            <div class="card-body">
                <div id="recent-sessions-container">
                    <p class="text-muted text-center">Ladataan sessiohistoriaa...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
let weeklyChart = null;

async function loadStats() {
    try {
        const response = await fetch('/api/stats');
        
        if (!response.ok) {
            throw new Error('Virhe tilastojen lataamisessa');
        }
        
        const data = await response.json();
        
        // Tarkista onko dataa
        if (!data.general || data.general.total_attempts === 0) {
            showEmptyState();
            return;
        }
        
        // Näytä tilastot
        showStats(data);
        
    } catch (error) {
        console.error('Virhe tilastojen lataamisessa:', error);
        showEmptyState();
    }
}

function showEmptyState() {
    document.getElementById('loading-spinner').style.display = 'none';
    document.getElementById('empty-state').style.display = 'block';
    document.getElementById('stats-content').style.display = 'none';
}

function showStats(data) {
    document.getElementById('loading-spinner').style.display = 'none';
    document.getElementById('empty-state').style.display = 'none';
    document.getElementById('stats-content').style.display = 'block';
    
    // Yleiset tilastot
    document.getElementById('total-questions').textContent = data.general.total_attempts || 0;
    document.getElementById('success-rate').textContent = 
        Math.round((data.general.avg_success_rate || 0) * 100) + '%';
    document.getElementById('avg-time').textContent = 
        (data.general.avg_time_per_question || 0).toFixed(1) + 's';
    
    // Hae käyttäjän putki
    loadStreak();
    
    // Kategoriatilastot
    if (data.categories && data.categories.length > 0) {
        renderCategoryStats(data.categories);
    } else {
        document.getElementById('category-stats-container').innerHTML = 
            '<p class="text-muted text-center">Ei kategoriatilastoja</p>';
    }
    
    // Vaikeustasotilastot
    if (data.difficulties && data.difficulties.length > 0) {
        renderDifficultyStats(data.difficulties);
    } else {
        document.getElementById('difficulty-stats-container').innerHTML = 
            '<p class="text-muted text-center">Ei vaikeustasotilastoja</p>';
    }
    
    // Viikottainen edistyminen
    if (data.weekly_progress && data.weekly_progress.length > 0) {
        renderWeeklyProgress(data.weekly_progress);
    } else {
        document.getElementById('weekly-progress-chart').parentElement.innerHTML = 
            '<p class="text-muted text-center">Ei aktiivisuushistoriaa</p>';
    }
    
    // Viimeisimmät sessiot
    if (data.recent_sessions && data.recent_sessions.length > 0) {
        renderRecentSessions(data.recent_sessions);
    } else {
        document.getElementById('recent-sessions-container').innerHTML = 
            '<p class="text-muted text-center">Ei sessiohistoriaa</p>';
    }
}

async function loadStreak() {
    try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        
        // Jos streak data on saatavilla
        if (data.streak) {
            document.getElementById('current-streak').textContent = data.streak.current_streak || 0;
        } else {
            document.getElementById('current-streak').textContent = '0';
        }
    } catch (error) {
        console.error('Virhe putken lataamisessa:', error);
        document.getElementById('current-streak').textContent = '0';
    }
}

function renderCategoryStats(categories) {
    const container = document.getElementById('category-stats-container');
    container.innerHTML = '';
    
    categories.forEach(cat => {
        const successRate = (cat.success_rate || 0) * 100;
        const barColor = successRate >= 70 ? 'bg-success' : successRate >= 50 ? 'bg-warning' : 'bg-danger';
        
        const html = `
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <strong>${cat.category}</strong>
                    <span class="text-muted">${successRate.toFixed(1)}% (${cat.attempts || 0} yritystä)</span>
                </div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar ${barColor}" role="progressbar" 
                         style="width: ${successRate}%" 
                         aria-valuenow="${successRate}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        ${successRate.toFixed(1)}%
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += html;
    });
}

function renderDifficultyStats(difficulties) {
    const container = document.getElementById('difficulty-stats-container');
    container.innerHTML = '';
    
    const difficultyLabels = {
        'helppo': 'Helppo',
        'keskivaikea': 'Keskivaikea',
        'vaikea': 'Vaikea'
    };
    
    difficulties.forEach(diff => {
        const successRate = (diff.success_rate || 0) * 100;
        const barColor = successRate >= 70 ? 'bg-success' : successRate >= 50 ? 'bg-warning' : 'bg-danger';
        const label = difficultyLabels[diff.difficulty] || diff.difficulty;
        
        const html = `
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <strong>${label}</strong>
                    <span class="text-muted">${successRate.toFixed(1)}% (${diff.attempts || 0} yritystä)</span>
                </div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar ${barColor}" role="progressbar" 
                         style="width: ${successRate}%" 
                         aria-valuenow="${successRate}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        ${successRate.toFixed(1)}%
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += html;
    });
}

function renderWeeklyProgress(weeklyData) {
    const ctx = document.getElementById('weekly-progress-chart').getContext('2d');
    
    // Tuhotaan vanha kaavio jos olemassa
    if (weeklyChart) {
        weeklyChart.destroy();
    }
    
    const labels = weeklyData.map(d => {
        const date = new Date(d.date);
        return date.toLocaleDateString('fi-FI', { day: 'numeric', month: 'short' });
    });
    
    const questionsData = weeklyData.map(d => d.questions_answered || 0);
    const correctsData = weeklyData.map(d => d.corrects || 0);
    
    weeklyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Vastatut kysymykset',
                    data: questionsData,
                    borderColor: 'rgb(90, 103, 216)',
                    backgroundColor: 'rgba(90, 103, 216, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Oikeat vastaukset',
                    data: correctsData,
                    borderColor: 'rgb(40, 167, 69)',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function renderRecentSessions(sessions) {
    const container = document.getElementById('recent-sessions-container');
    container.innerHTML = '';
    
    const sessionTypeLabels = {
        'practice': 'Harjoittelu',
        'simulation': 'Simulaatio',
        'review': 'Kertaus'
    };
    
    sessions.forEach(session => {
        const startDate = new Date(session.start_time);
        const percentage = session.questions_answered > 0 
            ? Math.round((session.questions_correct / session.questions_answered) * 100) 
            : 0;
        const badgeColor = percentage >= 70 ? 'bg-success' : percentage >= 50 ? 'bg-warning' : 'bg-danger';
        
        const html = `
            <div class="card mb-2 border-0 bg-light">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${sessionTypeLabels[session.session_type] || session.session_type}</strong>
                            <small class="text-muted ms-2">
                                ${startDate.toLocaleDateString('fi-FI')} ${startDate.toLocaleTimeString('fi-FI', { hour: '2-digit', minute: '2-digit' })}
                            </small>
                        </div>
                        <div>
                            <span class="badge ${badgeColor}">
                                ${session.questions_correct}/${session.questions_answered} (${percentage}%)
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += html;
    });
}

// Lataa tilastot sivun latautuessa
document.addEventListener('DOMContentLoaded', loadStats);
</script>
{% endblock %}